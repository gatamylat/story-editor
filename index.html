<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Story Editor">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#667eea">
  
  <title>Story Editor Pro</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS –∏–∫–æ–Ω–∫–∏ -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
  
  <!-- Splash screens –¥–ª—è iOS -->
  <link rel="apple-touch-startup-image" href="icons/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="icons/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="icons/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="icons/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  
  <style>
    /* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã —á–µ—Ä–µ–∑ base64 –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã */
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('data:font/woff2;base64,') format('woff2');
      /* –ó–¥–µ—Å—å –±—É–¥–µ—Ç base64 —à—Ä–∏—Ñ—Ç–∞ Inter Regular */
    }
    
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 600;
      font-display: swap;
      src: url('data:font/woff2;base64,') format('woff2');
      /* –ó–¥–µ—Å—å –±—É–¥–µ—Ç base64 —à—Ä–∏—Ñ—Ç–∞ Inter SemiBold */
    }
    
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 700;
      font-display: swap;
      src: url('data:font/woff2;base64,') format('woff2');
      /* –ó–¥–µ—Å—å –±—É–¥–µ—Ç base64 —à—Ä–∏—Ñ—Ç–∞ Inter Bold */
    }
    
    /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –∫–∞–∫ —Ñ–æ–ª–ª–±—ç–∫ */
    @font-face {
      font-family: 'System';
      font-style: normal;
      font-weight: 400;
      src: local('.SFNSText-Regular'), local('Helvetica Neue'), local('Helvetica'), local('Arial');
    }
    
    * { 
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    :root {
      --primary: #007aff;
      --primary-hover: #0051d5;
      --danger: #ff3b30;
      --success: #34c759;
      --warning: #ff9500;
      --bg-dark: #1c1c1e;
      --bg-medium: #2c2c2e;
      --bg-light: #f2f2f7;
      --border: #d1d1d6;
      --text: #000000;
      --text-secondary: #6c6c70;
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
    }
    
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      overflow: hidden; 
      font-family: 'Inter', 'System', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-light);
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }
    
    #app { 
      display: flex; 
      height: 100vh;
      padding-top: var(--safe-area-inset-top);
      padding-bottom: var(--safe-area-inset-bottom);
    }
    
    #sidebar { 
      width: 320px; 
      background: #ffffff; 
      border-right: 1px solid var(--border); 
      display: flex; 
      flex-direction: column; 
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
  #app {
    flex-direction: column;
    height: 100vh;
    height: 100dvh; /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è iOS */
  }
  
  #sidebar {
    width: 100%;
    height: auto;
    max-height: 60vh;
    border-right: none;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 20;
  }
  
  #canvas-container {
    flex: 1;
    min-height: 40vh;
  }
  
  /* –°–∫—Ä—ã–≤–∞–µ–º zoom control –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∂–µ—Å—Ç—ã */
  #zoom-control {
    display: none !important;
  }
  
  /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∞—á */
  button {
    min-height: 44px;
    font-size: 16px;
  }
  
  .section-content {
    padding: 16px;
  }
  
  input[type="number"], 
  input[type="text"],
  select {
    min-height: 44px;
    font-size: 16px !important;
  }
}

/* –ü–ª–∞–Ω—à–µ—Ç—ã –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ */
@media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
  #sidebar {
    width: 400px;
  }
}

/* –ü–ª–∞–Ω—à–µ—Ç—ã –≤ –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ */
@media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) {
  #sidebar {
    width: 350px;
  }
  
  #canvas-wrapper {
    margin: 20px;
  }
}

/* –ú–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã –≤ –ª–∞–Ω–¥—à–∞—Ñ—Ç–µ */
@media (max-height: 500px) and (orientation: landscape) {
  #sidebar {
    width: 300px;
  }
  
  .sidebar-header {
    padding: 8px;
    font-size: 16px;
  }
  
  details {
    max-height: 300px;
    overflow-y: auto;
  }
}
    
    .sidebar-header {
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .autosave-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      display: none;
    }
    
    .autosave-indicator.show {
      display: block;
      animation: pulse 1s ease;
    }
    
    @keyframes pulse {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    details { 
      margin: 0;
      border-bottom: 1px solid var(--border);
      background: #ffffff;
    }
    
    summary { 
      cursor: pointer; 
      padding: 12px 16px; 
      font-size: 14px; 
      font-weight: 600; 
      list-style: none;
      user-select: none;
      transition: background 0.2s;
      color: var(--text);
    }
    
    summary:hover {
      background: var(--bg-light);
    }
    
    summary::-webkit-details-marker { display: none; }
    
    summary:before { 
      content: "‚ñ∂"; 
      display: inline-block; 
      width: 1em; 
      margin-right: 8px;
      transition: transform 0.2s ease;
      color: var(--text-secondary);
    }
    
    details[open] summary:before { 
      transform: rotate(90deg); 
    }
    
    .section-content { 
      padding: 12px 16px; 
      display: flex; 
      flex-direction: column;
      gap: 10px;
    }
    
    label { 
      font-size: 13px; 
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .input-group input[type="number"] {
      flex: 1;
    }
    
    input[type="number"], 
    input[type="color"], 
    select, 
    button, 
    input[type="file"], 
    textarea { 
      width: 100%; 
      padding: 8px 12px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      font-size: 14px;
      transition: all 0.2s;
      background: white;
      color: var(--text);
      -webkit-appearance: none;
      appearance: none;
    }
    
    textarea, input[type="text"], input[type="number"] {
      -webkit-user-select: text;
      user-select: text;
    }
    
    input[type="number"] {
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
      height: 30px;
    }
    
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    input[type="checkbox"] { 
      margin-right: 6px;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    input[type="range"] {
      width: 100%;
      padding: 0;
      margin: 8px 0;
    }
    
    button { 
      cursor: pointer; 
      background: var(--primary); 
      color: white; 
      border: none;
      font-weight: 500;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    button:disabled { 
      background: var(--border); 
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    button.danger {
      background: var(--danger);
    }
    
    button.danger:hover:not(:disabled) {
      background: #d70015;
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }
    
    button.success {
      background: var(--success);
    }
    
    button.secondary {
      background: var(--text-secondary);
    }
    
    .button-group {
      display: flex;
      gap: 8px;
    }
    
    .button-group button {
      flex: 1;
    }
    
    #block-list { 
      margin-top: 12px; 
      border-top: 1px solid var(--border); 
      padding-top: 12px;
      max-height: 200px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .block-list-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .block-item { 
      padding: 10px; 
      margin-bottom: 6px; 
      border: 1px solid var(--border); 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px; 
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .block-item:hover {
      border-color: var(--primary);
      background: #f8f9fa;
    }
    
    .block-item.selected { 
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
    }
    
    .block-item-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--bg-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    #canvas-container { 
      flex-grow: 1; 
      background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                  linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                  linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                  linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      overflow: auto; 
      text-align: center; 
      white-space: nowrap; 
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    #canvas-wrapper { 
      display: inline-block; 
      background: #fff; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
      transform-origin: top left; 
      margin: 40px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    canvas { 
      display: block; 
      background: white; 
      cursor: grab;
      touch-action: none;
    }
    
    canvas.grabbing {
      cursor: grabbing;
    }
    
    #zoom-control { 
      position: absolute; 
      bottom: 20px; 
      right: 20px; 
      background: white; 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 12px 16px; 
      display: flex; 
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .zoom-buttons {
      display: flex;
      gap: 4px;
    }
    
    .zoom-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--bg-light);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 18px;
      color: var(--text);
    }
    
    .zoom-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    #zoom-control input[type="range"] { 
      width: 120px;
      margin: 0;
    }
    
    #zoomValue { 
      font-size: 14px;
      font-weight: 500;
      min-width: 40px;
      text-align: center;
      color: var(--text);
    }
    
    .gradient-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    
    .gradient-control span {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 60px;
    }
    
    .shortcuts-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text);
    }
    
    .shortcut-item kbd {
      background: var(--bg-light);
      padding: 3px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid var(--border);
      min-width: fit-content;
    }
    
    .shortcut-item span {
      color: var(--text-secondary);
    }
    
    /* iOS –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
    @supports (-webkit-touch-callout: none) {
      input, textarea, select {
        font-size: 16px !important;
      }
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .install-prompt.show {
      display: flex;
    }
    
    .install-prompt button {
      padding: 6px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="app">
  <div id="sidebar">
    <div class="sidebar-header">
      <button id="toggleSidebar" style="display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; font-size: 18px;">‚ò∞</button>
      üì± Story Editor Pro
      <span id="autosaveIndicator" class="autosave-indicator">‚úì –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
    </div>
    
    <details open>
      <summary>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö–æ–ª—Å—Ç–∞</summary>
      <div class="section-content">
        <label>–†–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞:</label>
        <div class="input-group">
          <input type="number" id="canvasWidth" value="1080" min="100" placeholder="–®–∏—Ä–∏–Ω–∞">
          <span>√ó</span>
          <input type="number" id="canvasHeight" value="1920" min="100" placeholder="–í—ã—Å–æ—Ç–∞">
        </div>
        <button id="resizeCanvasBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
        <div class="button-group">
          <button id="preset9x16" class="secondary">9:16</button>
          <button id="preset1x1" class="secondary">1:1</button>
          <button id="preset16x9" class="secondary">16:9</button>
        </div>
      </div>
    </details>

    <details>
      <summary>–§–æ–Ω</summary>
      <div class="section-content">
        <button id="bgUploadBtn">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
        <input type="file" id="bgUpload" accept="image/*" style="display: none;">
        <label>
          <input type="checkbox" id="moveBgMode"> 
          –†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–æ–Ω–∞
        </label>
        <button id="removeBgBtn" class="danger" style="display: none;">–£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
      </div>
    </details>

    <details>
      <summary>–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏</summary>
      <div class="section-content">
        <label>
          <input type="checkbox" id="showCenterLines"> 
          –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        </label>
        <label>
          <input type="checkbox" id="showSafeZones"> 
          –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ö—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—è
        </label>
        <label style="margin-left: 24px; font-size: 12px;">
          –°–≤–µ—Ä—Ö—É: <span id="safeZoneTopValue">250px</span>
        </label>
        <input type="range" id="safeZoneTop" min="50" max="400" value="250" style="margin-left: 24px;">
        <label style="margin-left: 24px; font-size: 12px;">
          –°–Ω–∏–∑—É: <span id="safeZoneBottomValue">100px</span>
        </label>
        <input type="range" id="safeZoneBottom" min="50" max="300" value="100" style="margin-left: 24px;">
      </div>
    </details>

    <details>
      <summary>–ì—Ä–∞–¥–∏–µ–Ω—Ç—ã</summary>
      <div class="section-content">
        <button id="addTopGradientBtn" class="secondary">+ –î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É</button>
        <button id="addBottomGradientBtn" class="secondary">+ –î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å–Ω–∏–∑—É</button>
        
        <div id="topGradientControls" style="display: none; margin-top: 12px;">
          <label style="font-weight: 600;">–ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É:</label>
          <div class="gradient-control" style="margin-left: 24px;">
            <span>–í—ã—Å–æ—Ç–∞:</span>
            <input type="range" id="topGradientHeight" min="100" max="600" value="300">
            <span id="topGradientHeightValue">300px</span>
          </div>
          <div class="gradient-control" style="margin-left: 24px;">
            <span>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:</span>
            <input type="range" id="topGradientOpacity" min="0" max="100" value="50">
            <span id="topGradientOpacityValue">50%</span>
          </div>
          <div class="button-group" style="margin-left: 24px; margin-top: 8px;">
            <button id="topGradientUp" class="secondary">‚Üë –í—ã—à–µ</button>
            <button id="topGradientDown" class="secondary">‚Üì –ù–∏–∂–µ</button>
          </div>
          <button id="removeTopGradientBtn" class="danger" style="margin-left: 24px; margin-top: 8px;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        
        <div id="bottomGradientControls" style="display: none; margin-top: 12px;">
          <label style="font-weight: 600;">–ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–Ω–∏–∑—É:</label>
          <div class="gradient-control" style="margin-left: 24px;">
            <span>–í—ã—Å–æ—Ç–∞:</span>
            <input type="range" id="bottomGradientHeight" min="100" max="600" value="300">
            <span id="bottomGradientHeightValue">300px</span>
          </div>
          <div class="gradient-control" style="margin-left: 24px;">
            <span>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:</span>
            <input type="range" id="bottomGradientOpacity" min="0" max="100" value="50">
            <span id="bottomGradientOpacityValue">50%</span>
          </div>
          <div class="button-group" style="margin-left: 24px; margin-top: 8px;">
            <button id="bottomGradientUp" class="secondary">‚Üë –í—ã—à–µ</button>
            <button id="bottomGradientDown" class="secondary">‚Üì –ù–∏–∂–µ</button>
          </div>
          <button id="removeBottomGradientBtn" class="danger" style="margin-left: 24px; margin-top: 8px;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </details>

    <details>
      <summary>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</summary>
      <div class="section-content">
        <div class="button-group">
          <button id="undoBtn" disabled>‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
          <button id="redoBtn" disabled>‚Ü∑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
        <button id="clearStorageBtn" class="danger" style="margin-top: 10px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</button>
      </div>
    </details>

    <details open>
      <summary>–ë–ª–æ–∫–∏ –∏ —Å–≤–æ–π—Å—Ç–≤–∞</summary>
      <div class="section-content">
        <div class="button-group">
          <button id="addTextBtn">üìù –¢–µ–∫—Å—Ç</button>
          <button id="addStickerBtn">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>
        </div>
        
        <div style="margin-top: 12px;">
          <label>–ü–æ–∑–∏—Ü–∏—è –∏ —Ä–∞–∑–º–µ—Ä:</label>
          <div class="input-group">
            <input type="number" id="propX" disabled placeholder="X">
            <input type="number" id="propY" disabled placeholder="Y">
          </div>
          <div class="input-group">
            <input type="number" id="propW" disabled placeholder="–®–∏—Ä–∏–Ω–∞">
            <input type="number" id="propH" disabled placeholder="–í—ã—Å–æ—Ç–∞">
          </div>
          <label>
            <input type="checkbox" id="keepAspectRatio" checked disabled>
            –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
          </label>
        </div>
        
        <div style="margin-top: 12px;">
          <label>–°—Ç–∏–ª—å –±–ª–æ–∫–∞:</label>
          <div class="input-group">
            <input type="color" id="propBgColor" disabled>
            <label style="flex: 1;">
              <input type="checkbox" id="propTransparentBg" disabled>
              –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
            </label>
          </div>
          <div class="input-group">
            <input type="number" id="propPaddingTop" value="20" disabled min="0" placeholder="–û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É">
            <input type="number" id="propBorderRadius" value="0" disabled min="0" placeholder="–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ">
          </div>
        </div>
        
        <div style="margin-top: 12px;">
          <label>–¢–µ–∫—Å—Ç:</label>
          <select id="propFontFamily" disabled>
            <option value="Inter, System, sans-serif">Inter (–û—Å–Ω–æ–≤–Ω–æ–π)</option>
            <option value="System, -apple-system, sans-serif">System UI</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="Courier New, monospace">Courier New</option>
          </select>
          <div class="input-group">
            <label style="flex: 0; white-space: nowrap;">–†–∞–∑–º–µ—Ä:</label>
            <input type="number" id="propFontSize" value="48" disabled min="8" max="200" placeholder="px" style="min-width: 80px;">
            <input type="color" id="propFontColor" value="#000000" disabled style="max-width: 60px;">
          </div>
          <div class="input-group">
            <label><input type="checkbox" id="propBold" disabled> –ñ–∏—Ä–Ω—ã–π</label>
            <label><input type="checkbox" id="propItalic" disabled> –ö—É—Ä—Å–∏–≤</label>
          </div>
          <select id="propTextAlign" disabled>
            <option value="left">–°–ª–µ–≤–∞</option>
            <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
            <option value="right">–°–ø—Ä–∞–≤–∞</option>
          </select>
          <textarea id="propText" rows="3" disabled placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        </div>
        
        <div class="button-group">
          <button id="deleteBlockBtn" class="danger" disabled>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          <button id="duplicateBtn" disabled>üìã –ö–æ–ø–∏—è</button>
        </div>
        <div class="button-group">
          <button id="bringForwardBtn" disabled>‚Üë –í—ã—à–µ</button>
          <button id="sendBackwardBtn" disabled>‚Üì –ù–∏–∂–µ</button>
        </div>
        
        <div id="block-list">
          <div class="block-list-header">–°–ø–∏—Å–æ–∫ –±–ª–æ–∫–æ–≤:</div>
        </div>
      </div>
    </details>

    <details>
      <summary>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</summary>
      <div class="section-content">
        <button id="saveProjectBtn" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
        <button id="loadProjectBtn" class="secondary">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
        <input type="file" id="loadProjectInput" accept=".json" style="display: none;">
        <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
          –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        </div>
      </div>
    </details>

    <details>
      <summary>–≠–∫—Å–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</summary>
      <div class="section-content">
        <button id="downloadBtn" class="success">üñºÔ∏è –°–∫–∞—á–∞—Ç—å PNG</button>
        <button id="copyBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button>
      </div>
    </details>

    <details>
      <summary>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</summary>
      <div class="section-content">
        <div style="font-size: 12px; color: var(--text-secondary);">
          <p>Story Editor Pro v2.0</p>
          <p>PWA –≤–µ—Ä—Å–∏—è –¥–ª—è iOS/Android</p>
          <p>–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω ‚úì</p>
          <button id="installBtn" class="secondary" style="display: none;">üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
        </div>
      </div>
    </details>
  </div>

  <div id="canvas-container">
    <div id="canvas-wrapper" style="transform: scale(0.5);">
      <canvas id="canvas" width="1080" height="1920"></canvas>
    </div>
    
    <div id="zoom-control">
      <div class="zoom-buttons">
        <button class="zoom-btn" id="zoomOut">‚àí</button>
        <button class="zoom-btn" id="zoomReset">‚ü≤</button>
        <button class="zoom-btn" id="zoomIn">+</button>
      </div>
      <input type="range" id="zoomSlider" min="0.1" max="3" step="0.1" value="0.5">
      <span id="zoomValue">50%</span>
    </div>
  </div>
</div>

<div id="installPrompt" class="install-prompt">
  <span>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Story Editor?</span>
  <button id="installConfirm">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  <button id="installCancel" class="secondary">–ü–æ–∑–∂–µ</button>
</div>

<script>
  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let canvasWidth = parseInt(document.getElementById('canvasWidth').value);
  let canvasHeight = parseInt(document.getElementById('canvasHeight').value);
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;

  let scale = 0.5;
  const canvasWrapper = document.getElementById('canvas-wrapper');
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  let showCenterLines = false;
  let showSafeZones = false;
  let safeZoneTop = 250;
  let safeZoneBottom = 100;
  
  // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã
  let topGradientBlock = null;
  let bottomGradientBlock = null;
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  let bgImage = new Image();
  let bgLoaded = false;
  let bgX = 0, bgY = 0, bgW = canvasWidth, bgH = canvasHeight;
  let moveBgMode = false;
  let blocks = [];
  let nextBlockId = 1;
  let selectedBlockId = null;
  let undoStack = [];
  let redoStack = [];
  const maxHistory = 50;
  
  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  let autosaveTimer = null;
  const AUTOSAVE_KEY = 'storyEditorProject';
  const AUTOSAVE_INTERVAL = 5000; // 5 —Å–µ–∫—É–Ω–¥

  // === SERVICE WORKER –î–õ–Ø PWA ===
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
      .catch(err => console.log('Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', err));
  }

  // === –£–°–¢–ê–ù–û–í–ö–ê PWA ===
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  const installPrompt = document.getElementById('installPrompt');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      if (deferredPrompt) {
        installPrompt.classList.add('show');
      }
    }, 30000);
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª: ${outcome}`);
      deferredPrompt = null;
      installBtn.style.display = 'none';
    }
  });

  document.getElementById('installConfirm').addEventListener('click', async () => {
    installPrompt.classList.remove('show');
    if (deferredPrompt) {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    }
  });

  document.getElementById('installCancel').addEventListener('click', () => {
    installPrompt.classList.remove('show');
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  window.addEventListener('appinstalled', () => {
    console.log('PWA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    installBtn.style.display = 'none';
    installPrompt.classList.remove('show');
  });

  // === –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –í LOCALSTORAGE ===
  function saveToLocalStorage() {
    try {
      const projectData = {
        version: '2.0',
        timestamp: new Date().toISOString(),
        canvas: { width: canvasWidth, height: canvasHeight },
        background: {
          loaded: bgLoaded,
          src: bgLoaded ? bgImage.src : null,
          x: bgX, y: bgY, width: bgW, height: bgH
        },
        blocks: blocks.map(block => {
          const blockData = { ...block };
          if (block.type === 'image') {
            blockData.imageSrc = block.img.src;
            delete blockData.img;
          }
          return blockData;
        }),
        settings: {
          showCenterLines, showSafeZones,
          safeZoneTop, safeZoneBottom, zoom: scale
        }
      };
      
      const dataStr = JSON.stringify(projectData);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (localStorage –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç ~5-10MB)
      if (dataStr.length < 5000000) { // 5MB –ª–∏–º–∏—Ç
        localStorage.setItem(AUTOSAVE_KEY, dataStr);
        showAutosaveIndicator();
        return true;
      } else {
        console.warn('–ü—Ä–æ–µ–∫—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        return false;
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
      return false;
    }
  }

  function loadFromLocalStorage() {
    try {
      const dataStr = localStorage.getItem(AUTOSAVE_KEY);
      if (!dataStr) return false;
      
      const projectData = JSON.parse(dataStr);
      if (!projectData.version) return false;
      
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
      restoreProject(projectData);
      return true;
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
      return false;
    }
  }

  function showAutosaveIndicator() {
    const indicator = document.getElementById('autosaveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
      indicator.classList.remove('show');
    }, 2000);
  }

  function startAutosave() {
    stopAutosave();
    autosaveTimer = setInterval(() => {
      if (blocks.length > 0 || bgLoaded) {
        saveToLocalStorage();
      }
    }, AUTOSAVE_INTERVAL);
  }

  function stopAutosave() {
    if (autosaveTimer) {
      clearInterval(autosaveTimer);
      autosaveTimer = null;
    }
  }

  document.getElementById('clearStorageBtn').addEventListener('click', () => {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
      localStorage.removeItem(AUTOSAVE_KEY);
      alert('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ');
    }
  });

// === –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–ê–°–®–¢–ê–ë–û–ú (—É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ) ===
// –≠—Ç–æ—Ç –±–ª–æ–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ü–†–ï–°–ï–¢–û–í ===
document.getElementById('preset9x16').addEventListener('click', () => {
  document.getElementById('canvasWidth').value = 1080;
  document.getElementById('canvasHeight').value = 1920;
  document.getElementById('resizeCanvasBtn').click();
});

document.getElementById('preset1x1').addEventListener('click', () => {
  document.getElementById('canvasWidth').value = 1080;
  document.getElementById('canvasHeight').value = 1080;
  document.getElementById('resizeCanvasBtn').click();
});

document.getElementById('preset16x9').addEventListener('click', () => {
  document.getElementById('canvasWidth').value = 1920;
  document.getElementById('canvasHeight').value = 1080;
  document.getElementById('resizeCanvasBtn').click();
});

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–• –õ–ò–ù–ò–ô ===
document.getElementById('showCenterLines').addEventListener('change', e => {
  showCenterLines = e.target.checked;
  redrawCanvas();
});

document.getElementById('showSafeZones').addEventListener('change', e => {
  showSafeZones = e.target.checked;
  redrawCanvas();
});

document.getElementById('safeZoneTop').addEventListener('input', e => {
  safeZoneTop = parseInt(e.target.value);
  document.getElementById('safeZoneTopValue').textContent = safeZoneTop + 'px';
  if (showSafeZones) redrawCanvas();
});

document.getElementById('safeZoneBottom').addEventListener('input', e => {
  safeZoneBottom = parseInt(e.target.value);
  document.getElementById('safeZoneBottomValue').textContent = safeZoneBottom + 'px';
  if (showSafeZones) redrawCanvas();
});

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ì–†–ê–î–ò–ï–ù–¢–û–í ===
document.getElementById('addTopGradientBtn').addEventListener('click', () => {
  if (!topGradientBlock) {
    pushStateToUndo();
    topGradientBlock = {
      id: nextBlockId++,
      type: 'gradient',
      gradientType: 'top',
      height: 300,
      opacity: 0.5,
      zIndex: blocks.length + 1
    };
    blocks.push(topGradientBlock);
    document.getElementById('topGradientControls').style.display = 'block';
    document.getElementById('addTopGradientBtn').style.display = 'none';
    refreshBlockList();
    redrawCanvas();
  }
});

document.getElementById('addBottomGradientBtn').addEventListener('click', () => {
  if (!bottomGradientBlock) {
    pushStateToUndo();
    bottomGradientBlock = {
      id: nextBlockId++,
      type: 'gradient',
      gradientType: 'bottom',
      height: 300,
      opacity: 0.5,
      zIndex: blocks.length + 1
    };
    blocks.push(bottomGradientBlock);
    document.getElementById('bottomGradientControls').style.display = 'block';
    document.getElementById('addBottomGradientBtn').style.display = 'none';
    refreshBlockList();
    redrawCanvas();
  }
});

document.getElementById('removeTopGradientBtn').addEventListener('click', () => {
  if (topGradientBlock) {
    pushStateToUndo();
    blocks = blocks.filter(b => b.id !== topGradientBlock.id);
    topGradientBlock = null;
    document.getElementById('topGradientControls').style.display = 'none';
    document.getElementById('addTopGradientBtn').style.display = 'block';
    refreshBlockList();
    redrawCanvas();
  }
});

document.getElementById('removeBottomGradientBtn').addEventListener('click', () => {
  if (bottomGradientBlock) {
    pushStateToUndo();
    blocks = blocks.filter(b => b.id !== bottomGradientBlock.id);
    bottomGradientBlock = null;
    document.getElementById('bottomGradientControls').style.display = 'none';
    document.getElementById('addBottomGradientBtn').style.display = 'block';
    refreshBlockList();
    redrawCanvas();
  }
});

document.getElementById('topGradientHeight').addEventListener('input', e => {
  if (topGradientBlock) {
    topGradientBlock.height = parseInt(e.target.value);
    document.getElementById('topGradientHeightValue').textContent = topGradientBlock.height + 'px';
    redrawCanvas();
  }
});

document.getElementById('topGradientOpacity').addEventListener('input', e => {
  if (topGradientBlock) {
    topGradientBlock.opacity = parseInt(e.target.value) / 100;
    document.getElementById('topGradientOpacityValue').textContent = e.target.value + '%';
    redrawCanvas();
  }
});

document.getElementById('bottomGradientHeight').addEventListener('input', e => {
  if (bottomGradientBlock) {
    bottomGradientBlock.height = parseInt(e.target.value);
    document.getElementById('bottomGradientHeightValue').textContent = bottomGradientBlock.height + 'px';
    redrawCanvas();
  }
});

document.getElementById('bottomGradientOpacity').addEventListener('input', e => {
  if (bottomGradientBlock) {
    bottomGradientBlock.opacity = parseInt(e.target.value) / 100;
    document.getElementById('bottomGradientOpacityValue').textContent = e.target.value + '%';
    redrawCanvas();
  }
});

document.getElementById('topGradientUp').addEventListener('click', () => {
  if (topGradientBlock) {
    pushStateToUndo();
    topGradientBlock.zIndex = Math.max(...blocks.map(x => x.zIndex)) + 1;
    redrawCanvas();
  }
});

document.getElementById('topGradientDown').addEventListener('click', () => {
  if (topGradientBlock) {
    pushStateToUndo();
    topGradientBlock.zIndex = Math.min(...blocks.map(x => x.zIndex)) - 1;
    redrawCanvas();
  }
});

document.getElementById('bottomGradientUp').addEventListener('click', () => {
  if (bottomGradientBlock) {
    pushStateToUndo();
    bottomGradientBlock.zIndex = Math.max(...blocks.map(x => x.zIndex)) + 1;
    redrawCanvas();
  }
});

document.getElementById('bottomGradientDown').addEventListener('click', () => {
  if (bottomGradientBlock) {
    pushStateToUndo();
    bottomGradientBlock.zIndex = Math.min(...blocks.map(x => x.zIndex)) - 1;
    redrawCanvas();
  }
});

// === –§–£–ù–ö–¶–ò–ò –ò–°–¢–û–†–ò–ò ===
function pushStateToUndo() {
  const state = {
    blocks: JSON.parse(JSON.stringify(blocks, (key, value) => {
      if (value && value instanceof Image) return { __img__: true, src: value.src };
      return value;
    })),
    bgLoaded, bgX, bgY, bgW, bgH, canvasWidth, canvasHeight, bgSrc: bgLoaded ? bgImage.src : null
  };
  undoStack.push(state);
  if (undoStack.length > maxHistory) undoStack.shift();
  redoStack = [];
  updateUndoRedoButtons();
}

function restoreState(state) {
  blocks = state.blocks.map(b => {
    if (b.type === 'image') {
      const img = new Image();
      img.src = b.img.src;
      return { ...b, img };
    }
    return { ...b };
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –±–ª–æ–∫–∏
  topGradientBlock = blocks.find(b => b.type === 'gradient' && b.gradientType === 'top') || null;
  bottomGradientBlock = blocks.find(b => b.type === 'gradient' && b.gradientType === 'bottom') || null;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤
  if (topGradientBlock) {
    document.getElementById('topGradientControls').style.display = 'block';
    document.getElementById('addTopGradientBtn').style.display = 'none';
    document.getElementById('topGradientHeight').value = topGradientBlock.height;
    document.getElementById('topGradientHeightValue').textContent = topGradientBlock.height + 'px';
    document.getElementById('topGradientOpacity').value = topGradientBlock.opacity * 100;
    document.getElementById('topGradientOpacityValue').textContent = (topGradientBlock.opacity * 100) + '%';
  } else {
    document.getElementById('topGradientControls').style.display = 'none';
    document.getElementById('addTopGradientBtn').style.display = 'block';
  }
  
  if (bottomGradientBlock) {
    document.getElementById('bottomGradientControls').style.display = 'block';
    document.getElementById('addBottomGradientBtn').style.display = 'none';
    document.getElementById('bottomGradientHeight').value = bottomGradientBlock.height;
    document.getElementById('bottomGradientHeightValue').textContent = bottomGradientBlock.height + 'px';
    document.getElementById('bottomGradientOpacity').value = bottomGradientBlock.opacity * 100;
    document.getElementById('bottomGradientOpacityValue').textContent = (bottomGradientBlock.opacity * 100) + '%';
  } else {
    document.getElementById('bottomGradientControls').style.display = 'none';
    document.getElementById('addBottomGradientBtn').style.display = 'block';
  }
  
  if (state.bgLoaded && state.bgSrc) {
    bgImage.src = state.bgSrc;
    bgImage.onload = () => {
      bgLoaded = true;
      bgX = state.bgX;
      bgY = state.bgY;
      bgW = state.bgW;
      bgH = state.bgH;
      redrawCanvas();
    };
  } else {
    bgLoaded = false;
    bgX = state.bgX;
    bgY = state.bgY;
    bgW = state.bgW;
    bgH = state.bgH;
  }
  
  canvasWidth = state.canvasWidth;
  canvasHeight = state.canvasHeight;
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  document.getElementById('canvasWidth').value = canvasWidth;
  document.getElementById('canvasHeight').value = canvasHeight;
  selectedBlockId = null;
  deactivateBlockSelection();
  refreshBlockList();
  redrawCanvas();
}

function undo() {
  if (!undoStack.length) return;
  const currentState = {
    blocks: JSON.parse(JSON.stringify(blocks, (key, value) => {
      if (value && value instanceof Image) return { __img__: true, src: value.src };
      return value;
    })),
    bgLoaded, bgX, bgY, bgW, bgH, canvasWidth, canvasHeight, bgSrc: bgLoaded ? bgImage.src : null
  };
  redoStack.push(currentState);
  const prevState = undoStack.pop();
  restoreState(prevState);
  updateUndoRedoButtons();
}

function redo() {
  if (!redoStack.length) return;
  const currentState = {
    blocks: JSON.parse(JSON.stringify(blocks, (key, value) => {
      if (value && value instanceof Image) return { __img__: true, src: value.src };
      return value;
    })),
    bgLoaded, bgX, bgY, bgW, bgH, canvasWidth, canvasHeight, bgSrc: bgLoaded ? bgImage.src : null
  };
  undoStack.push(currentState);
  const nextState = redoStack.pop();
  restoreState(nextState);
  updateUndoRedoButtons();
}

function updateUndoRedoButtons() {
  document.getElementById('undoBtn').disabled = !undoStack.length;
  document.getElementById('redoBtn').disabled = !redoStack.length;
}

document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('redoBtn').addEventListener('click', redo);

// === –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò ===
function getBlockById(id) { 
  return blocks.find(b => b.id === id); 
}

function sortBlocks() { 
  blocks.sort((a, b) => a.zIndex - b.zIndex); 
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π
function drawGuides(ctx) {
  ctx.save();
  
  // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
  if (showCenterLines) {
    ctx.strokeStyle = 'rgba(255, 0, 255, 0.5)';
    ctx.lineWidth = 1;
    ctx.setLineDash([10, 5]);
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
    ctx.beginPath();
    ctx.moveTo(canvasWidth / 2, 0);
    ctx.lineTo(canvasWidth / 2, canvasHeight);
    ctx.stroke();
    
    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
    ctx.beginPath();
    ctx.moveTo(0, canvasHeight / 2);
    ctx.lineTo(canvasWidth, canvasHeight / 2);
    ctx.stroke();
  }
  
  // –û—Ö—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—è
  if (showSafeZones) {
    ctx.strokeStyle = 'rgba(255, 0, 0, 0.6)';
    ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
    ctx.lineWidth = 2;
    ctx.setLineDash([15, 5]);
    
    // –í–µ—Ä—Ö–Ω–µ–µ –æ—Ö—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ
    ctx.fillRect(0, 0, canvasWidth, safeZoneTop);
    ctx.beginPath();
    ctx.moveTo(0, safeZoneTop);
    ctx.lineTo(canvasWidth, safeZoneTop);
    ctx.stroke();
    
    // –ù–∏–∂–Ω–µ–µ –æ—Ö—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ
    ctx.fillRect(0, canvasHeight - safeZoneBottom, canvasWidth, safeZoneBottom);
    ctx.beginPath();
    ctx.moveTo(0, canvasHeight - safeZoneBottom);
    ctx.lineTo(canvasWidth, canvasHeight - safeZoneBottom);
    ctx.stroke();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –∫ –æ—Ö—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—è–º
    ctx.setLineDash([]);
    ctx.font = '14px Inter, sans-serif';
    ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
    ctx.fillText('–û—Ö—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ (–≤–µ—Ä—Ö)', 10, safeZoneTop - 10);
    ctx.fillText('–û—Ö—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ (–Ω–∏–∑)', 10, canvasHeight - safeZoneBottom + 20);
  }
  
  ctx.restore();
}

function redrawCanvas(forExport = false) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // –†–∏—Å—É–µ–º —Ñ–æ–Ω
  if (bgLoaded) {
    ctx.drawImage(bgImage, bgX, bgY, bgW, bgH);
  } else {
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ —Ä–∏—Å—É–µ–º –≤—Å–µ –±–ª–æ–∫–∏
  sortBlocks();
  for (let block of blocks) {
    ctx.save();
    
    // –†–∏—Å—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã
    if (block.type === 'gradient') {
      if (block.gradientType === 'top') {
        const gradient = ctx.createLinearGradient(0, 0, 0, block.height);
        gradient.addColorStop(0, `rgba(0, 0, 0, ${block.opacity})`);
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvasWidth, block.height);
      } else if (block.gradientType === 'bottom') {
        const gradient = ctx.createLinearGradient(0, canvasHeight - block.height, 0, canvasHeight);
        gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
        gradient.addColorStop(1, `rgba(0, 0, 0, ${block.opacity})`);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, canvasHeight - block.height, canvasWidth, block.height);
      }
    }
    
    // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏
    if (block.type === 'text') {
      if (block.bgColor && block.bgColor !== 'rgba(0,0,0,0)') {
        ctx.fillStyle = block.bgColor;
        if (block.borderRadius > 0) {
          roundRect(ctx, block.x, block.y, block.w, block.h, block.borderRadius, true, false);
        } else {
          ctx.fillRect(block.x, block.y, block.w, block.h);
        }
      }
      let style = '';
      if (block.italic) style += 'italic ';
      if (block.bold) style += 'bold ';
      style += `${block.fontSize}px ${block.fontFamily}`;
      ctx.font = style;
      ctx.fillStyle = block.fontColor;
      ctx.textAlign = block.textAlign;
      ctx.textBaseline = 'top';
      let textX = block.x + (block.textAlign === 'center' ? block.w / 2 : block.textAlign === 'right' ? block.w - 10 : 10);
      let lines = block.text.split('\n');
      let lineHeight = block.fontSize * 1.2;
      for (let i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i], textX, block.y + block.paddingTop + i * lineHeight);
      }
    }
    
    // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (block.type === 'image') {
      ctx.drawImage(block.img, block.x, block.y, block.w, block.h);
    }
    
    // –†–∏—Å—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (–Ω–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤)
    if (block.id === selectedBlockId && !moveBgMode && !forExport && block.type !== 'gradient') {
      ctx.strokeStyle = '#007aff';
      ctx.lineWidth = 2;
      ctx.setLineDash([6, 4]);
      ctx.strokeRect(block.x - 2, block.y - 2, block.w + 4, block.h + 4);
      ctx.setLineDash([]);
      drawResizeHandles(ctx, block);
    }
    
    ctx.restore();
  }
  
  // –†–∏—Å—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —ç–∫—Å–ø–æ—Ä—Ç)
  if (!forExport) {
    drawGuides(ctx);
  }
}

function drawResizeHandles(ctx, block) {
  const handles = getResizeHandles(block);
  ctx.fillStyle = '#007aff';
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 2;
  
  for (let handle of handles) {
    ctx.beginPath();
    if (['n', 's'].includes(handle.position)) {
      ctx.roundRect(handle.x - 8, handle.y - 4, 16, 8, 4);
    } else if (['e', 'w'].includes(handle.position)) {
      ctx.roundRect(handle.x - 4, handle.y - 8, 8, 16, 4);
    } else {
      ctx.arc(handle.x, handle.y, 6, 0, Math.PI * 2);
    }
    ctx.fill();
    ctx.stroke();
  }
}

function getResizeHandles(block) {
  return [
    { x: block.x, y: block.y, position: 'nw' },
    { x: block.x + block.w / 2, y: block.y, position: 'n' },
    { x: block.x + block.w, y: block.y, position: 'ne' },
    { x: block.x + block.w, y: block.y + block.h / 2, position: 'e' },
    { x: block.x + block.w, y: block.y + block.h, position: 'se' },
    { x: block.x + block.w / 2, y: block.y + block.h, position: 's' },
    { x: block.x, y: block.y + block.h, position: 'sw' },
    { x: block.x, y: block.y + block.h / 2, position: 'w' }
  ];
}

function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  if (w < 2 * r) r = w / 2;
  if (h < 2 * r) r = h / 2;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

// === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ë–õ–û–ö–ê–ú–ò ===
const blockListDiv = document.getElementById('block-list');

function refreshBlockList() {
  Array.from(blockListDiv.children).forEach(ch => {
    if (ch.classList.contains('block-item')) blockListDiv.removeChild(ch);
  });
  
  for (let block of blocks) {
    const div = document.createElement('div');
    div.className = 'block-item';
    if (block.id === selectedBlockId) div.classList.add('selected');
    
    const icon = document.createElement('div');
    icon.className = 'block-item-icon';
    
    let text = document.createElement('span');
    
    if (block.type === 'text') {
      icon.textContent = 'üìù';
      text.textContent = `–¢–µ–∫—Å—Ç: ${block.text.substring(0, 20)}${block.text.length > 20 ? '...' : ''}`;
    } else if (block.type === 'image') {
      icon.textContent = 'üñºÔ∏è';
      text.textContent = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${block.id}`;
    } else if (block.type === 'gradient') {
      icon.textContent = 'üåà';
      text.textContent = block.gradientType === 'top' ? '–ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É' : '–ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–Ω–∏–∑—É';
    }
    
    div.appendChild(icon);
    div.appendChild(text);
    
    div.onclick = () => {
      if (!moveBgMode && block.type !== 'gradient') {
        selectBlock(block.id);
        redrawCanvas();
      }
    };
    
    blockListDiv.appendChild(div);
  }
}

function selectBlock(id) {
  selectedBlockId = id;
  const b = getBlockById(id);
  
  ['propX','propY','propW','propH','keepAspectRatio'].forEach(idf => {
    document.getElementById(idf).disabled = false;
  });
  
  ['propBgColor','propTransparentBg','propPaddingTop','propBorderRadius',
   'propFontFamily','propFontSize','propFontColor','propBold','propItalic',
   'propTextAlign','propText'].forEach(idf => {
    document.getElementById(idf).disabled = (b.type !== 'text');
  });
  
  ['deleteBlockBtn','duplicateBtn','bringForwardBtn','sendBackwardBtn'].forEach(idf => {
    document.getElementById(idf).disabled = false;
  });
  
  document.getElementById('propX').value = Math.round(b.x);
  document.getElementById('propY').value = Math.round(b.y);
  document.getElementById('propW').value = Math.round(b.w);
  document.getElementById('propH').value = Math.round(b.h);
  document.getElementById('keepAspectRatio').checked = b.type === 'image';
  
  if (b.type === 'text') {
    document.getElementById('propBgColor').value = rgbaToHex(b.bgColor);
    document.getElementById('propTransparentBg').checked = (b.bgColor === 'rgba(0,0,0,0)');
    document.getElementById('propPaddingTop').value = b.paddingTop;
    document.getElementById('propBorderRadius').value = b.borderRadius;
    document.getElementById('propFontFamily').value = b.fontFamily;
    document.getElementById('propFontSize').value = b.fontSize;
    document.getElementById('propFontColor').value = b.fontColor;
    document.getElementById('propBold').checked = b.bold;
    document.getElementById('propItalic').checked = b.italic;
    document.getElementById('propTextAlign').value = b.textAlign;
    document.getElementById('propText').value = b.text;
  }
  
  refreshBlockList();
}

function deactivateBlockSelection() {
  selectedBlockId = null;
  ['propX','propY','propW','propH','keepAspectRatio','propBgColor',
   'propTransparentBg','propPaddingTop','propBorderRadius','propFontFamily',
   'propFontSize','propFontColor','propBold','propItalic','propTextAlign',
   'propText','deleteBlockBtn','duplicateBtn','bringForwardBtn','sendBackwardBtn'].forEach(idf => {
    document.getElementById(idf).disabled = true;
  });
  refreshBlockList();
  redrawCanvas();
}

function updateSelectedBlockProps() {
  if (selectedBlockId == null) return;
  const b = getBlockById(selectedBlockId);
  const keepAspect = document.getElementById('keepAspectRatio').checked;
  
  const newX = parseInt(document.getElementById('propX').value) || b.x;
  const newY = parseInt(document.getElementById('propY').value) || b.y;
  let newW = parseInt(document.getElementById('propW').value) || b.w;
  let newH = parseInt(document.getElementById('propH').value) || b.h;
  
  if (b.type === 'image' && keepAspect && b.aspectRatio) {
    if (this.id === 'propW') {
      newH = newW / b.aspectRatio;
      document.getElementById('propH').value = Math.round(newH);
    } else if (this.id === 'propH') {
      newW = newH * b.aspectRatio;
      document.getElementById('propW').value = Math.round(newW);
    }
  }
  
  b.x = newX;
  b.y = newY;
  b.w = newW;
  b.h = newH;
  
  if (b.type === 'text') {
    if (document.getElementById('propTransparentBg').checked) {
      b.bgColor = 'rgba(0,0,0,0)';
    } else {
      b.bgColor = hexToRgba(document.getElementById('propBgColor').value, 0.9);
    }
    b.paddingTop = parseInt(document.getElementById('propPaddingTop').value) || 0;
    b.borderRadius = parseInt(document.getElementById('propBorderRadius').value) || 0;
    b.fontFamily = document.getElementById('propFontFamily').value;
    b.fontSize = parseInt(document.getElementById('propFontSize').value) || b.fontSize;
    b.fontColor = document.getElementById('propFontColor').value;
    b.bold = document.getElementById('propBold').checked;
    b.italic = document.getElementById('propItalic').checked;
    b.textAlign = document.getElementById('propTextAlign').value;
    b.text = document.getElementById('propText').value;
  }
  
  redrawCanvas();
}

// === –î–û–ë–ê–í–õ–ï–ù–ò–ï –ë–õ–û–ö–û–í ===
document.getElementById('addTextBtn').addEventListener('click', () => {
  pushStateToUndo();
  const newBlock = {
    id: nextBlockId++,
    type: 'text',
    x: 50,
    y: 50,
    w: 400,
    h: 150,
    zIndex: blocks.length + 1,
    text: '–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç',
    fontFamily: 'Inter, System, sans-serif',
    fontSize: 48,
    fontColor: '#000000',
    bold: false,
    italic: false,
    textAlign: 'left',
    bgColor: 'rgba(255,255,255,0.9)',
    borderRadius: 8,
    paddingTop: 20
  };
  blocks.push(newBlock);
  selectBlock(newBlock.id);
  refreshBlockList();
  redrawCanvas();
});

document.getElementById('addStickerBtn').addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    const reader = new FileReader();
    reader.onload = ev => {
      img.src = ev.target.result;
      img.onload = () => {
        pushStateToUndo();
        const aspect = img.width / img.height;
        const w0 = 300;
        const h0 = w0 / aspect;
        const newBlock = {
          id: nextBlockId++,
          type: 'image',
          img: img,
          x: 100,
          y: 100,
          w: w0,
          h: h0,
          zIndex: blocks.length + 1,
          aspectRatio: aspect
        };
        blocks.push(newBlock);
        selectBlock(newBlock.id);
        refreshBlockList();
        redrawCanvas();
      };
    };
    reader.readAsDataURL(file);
  };
  input.click();
});

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–í–û–ô–°–¢–í ===
['propX','propY','propW','propH'].forEach(idf => {
  const el = document.getElementById(idf);
  el.addEventListener('input', updateSelectedBlockProps);
  el.addEventListener('blur', () => pushStateToUndo());
});

['propBgColor','propTransparentBg','propPaddingTop','propBorderRadius',
 'propFontFamily','propFontSize','propFontColor','propBold','propItalic',
 'propTextAlign','propText'].forEach(idf => {
  const el = document.getElementById(idf);
  el.addEventListener('input', updateSelectedBlockProps);
  el.addEventListener('change', () => pushStateToUndo());
});

// === –û–ü–ï–†–ê–¶–ò–ò –° –ë–õ–û–ö–ê–ú–ò ===
document.getElementById('deleteBlockBtn').addEventListener('click', () => {
  if (selectedBlockId == null) return;
  pushStateToUndo();
  blocks = blocks.filter(b => b.id !== selectedBlockId);
  selectedBlockId = null;
  deactivateBlockSelection();
  refreshBlockList();
  redrawCanvas();
});

function duplicateBlock() {
  if (selectedBlockId == null) return;
  pushStateToUndo();
  const original = getBlockById(selectedBlockId);
  const newBlock = {
    ...original,
    id: nextBlockId++,
    x: original.x + 20,
    y: original.y + 20,
    zIndex: Math.max(...blocks.map(x => x.zIndex)) + 1
  };
  if (original.type === 'image') {
    newBlock.img = original.img;
  }
  blocks.push(newBlock);
  selectBlock(newBlock.id);
  refreshBlockList();
  redrawCanvas();
}

document.getElementById('duplicateBtn').addEventListener('click', duplicateBlock);

document.getElementById('bringForwardBtn').addEventListener('click', () => {
  if (selectedBlockId == null) return;
  pushStateToUndo();
  const b = getBlockById(selectedBlockId);
  b.zIndex = Math.max(...blocks.map(x => x.zIndex)) + 1;
  redrawCanvas();
  refreshBlockList();
});

document.getElementById('sendBackwardBtn').addEventListener('click', () => {
  if (selectedBlockId == null) return;
  pushStateToUndo();
  const b = getBlockById(selectedBlockId);
  b.zIndex = Math.min(...blocks.map(x => x.zIndex)) - 1;
  redrawCanvas();
  refreshBlockList();
});

// === –†–ê–ë–û–¢–ê –° –ú–´–®–¨–Æ –ò TOUCH ===
let isDragging = false;
let isResizing = false;
let dragOffsetX = 0, dragOffsetY = 0;
let draggingBg = false, draggingBlock = false;
let resizeHandle = null;
let originalBlock = null;
let touchStartX = 0, touchStartY = 0;

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
function getEventCoords(e) {
  if (e.touches && e.touches.length > 0) {
    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
  return { x: e.clientX, y: e.clientY };
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–º—ã—à—å –∏ touch)
function handleStart(e) {
  e.preventDefault();
  const coords = getEventCoords(e);
  const rect = canvas.getBoundingClientRect();
  const mx = (coords.x - rect.left) / scale;
  const my = (coords.y - rect.top) / scale;
  
  if (e.touches) {
    touchStartX = coords.x;
    touchStartY = coords.y;
  }
  
  if (moveBgMode && bgLoaded) {
    if (mx >= bgX && mx <= bgX + bgW && my >= bgY && my <= bgY + bgH) {
      draggingBg = true;
      dragOffsetX = mx - bgX;
      dragOffsetY = my - bgY;
      isDragging = true;
      canvas.classList.add('grabbing');
    }
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—É—á–µ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
  if (selectedBlockId) {
    const block = getBlockById(selectedBlockId);
    const handles = getResizeHandles(block);
    for (let handle of handles) {
      const dist = Math.sqrt((mx - handle.x) ** 2 + (my - handle.y) ** 2);
      if (dist < 15) { // –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–¥–∏—É—Å –¥–ª—è touch
        isResizing = true;
        resizeHandle = handle.position;
        originalBlock = { ...block };
        return;
      }
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
  let hitBlock = null;
  for (let i = blocks.length - 1; i >= 0; i--) {
    const b = blocks[i];
    if (b.type === 'gradient') continue;
    if (mx >= b.x && mx <= b.x + b.w && my >= b.y && my <= b.y + b.h) {
      hitBlock = b;
      break;
    }
  }
  
  if (hitBlock) {
    selectBlock(hitBlock.id);
    draggingBlock = true;
    dragOffsetX = mx - hitBlock.x;
    dragOffsetY = my - hitBlock.y;
    isDragging = true;
    canvas.classList.add('grabbing');
  } else {
    deactivateBlockSelection();
  }
  
  redrawCanvas();
}

// === –ü–û–î–î–ï–†–ñ–ö–ê –ñ–ï–°–¢–û–í –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø ===
let lastTouchDistance = 0;
let isPinching = false;

function getTouchDistance(touches) {
  if (touches.length < 2) return 0;
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ handleMove –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ "const coords = getEventCoords(e);"
function handleTouchMove(e) {
  if (e.touches && e.touches.length === 2) {
    e.preventDefault();
    const distance = getTouchDistance(e.touches);
    
    if (!isPinching) {
      isPinching = true;
      lastTouchDistance = distance;
      return;
    }
    
    const delta = distance - lastTouchDistance;
    const scaleSpeed = 0.01;
    scale = Math.min(3, Math.max(0.1, scale + (delta * scaleSpeed)));
    
    document.getElementById('zoomSlider').value = scale;
    updateZoom();
    
    lastTouchDistance = distance;
    return;
  } else if (e.touches && e.touches.length === 1 && !isPinching) {
    handleMove(e);
  }
}

// –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–∏–Ω—á–∞
canvas.addEventListener('touchend', (e) => {
  if (e.touches.length < 2) {
    isPinching = false;
    lastTouchDistance = 0;
  }
  handleEnd(e);
});

// –ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ touchmove
canvas.removeEventListener('touchmove', handleMove);
canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
  
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–º—ã—à—å –∏ touch)
function handleMove(e) {
  const coords = getEventCoords(e);
  const rect = canvas.getBoundingClientRect();
  const mx = (coords.x - rect.left) / scale;
  const my = (coords.y - rect.top) / scale;
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º—ã—à–∏)
  if (!e.touches && !isDragging && !isResizing && selectedBlockId && !moveBgMode) {
    const block = getBlockById(selectedBlockId);
    const handles = getResizeHandles(block);
    let onHandle = false;
    for (let handle of handles) {
      const dist = Math.sqrt((mx - handle.x) ** 2 + (my - handle.y) ** 2);
      if (dist < 10) {
        onHandle = true;
        const cursorMap = {
          'nw': 'nwse-resize', 'ne': 'nesw-resize',
          'sw': 'nesw-resize', 'se': 'nwse-resize',
          'n': 'ns-resize', 's': 'ns-resize',
          'e': 'ew-resize', 'w': 'ew-resize'
        };
        canvas.style.cursor = cursorMap[handle.position];
        break;
      }
    }
    if (!onHandle) {
      canvas.style.cursor = 'grab';
    }
  }
  
  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
  if (isResizing && selectedBlockId) {
    const block = getBlockById(selectedBlockId);
    const keepAspect = document.getElementById('keepAspectRatio').checked && block.type === 'image';
    
    switch(resizeHandle) {
      case 'se':
        block.w = Math.max(50, mx - block.x);
        if (keepAspect) {
          block.h = block.w / block.aspectRatio;
        } else {
          block.h = Math.max(50, my - block.y);
        }
        break;
      case 'nw':
        const newW = Math.max(50, originalBlock.x + originalBlock.w - mx);
        const newH = keepAspect ? newW / block.aspectRatio : Math.max(50, originalBlock.y + originalBlock.h - my);
        block.x = originalBlock.x + originalBlock.w - newW;
        block.y = originalBlock.y + originalBlock.h - newH;
        block.w = newW;
        block.h = newH;
        break;
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ...
    }
    
    document.getElementById('propX').value = Math.round(block.x);
    document.getElementById('propY').value = Math.round(block.y);
    document.getElementById('propW').value = Math.round(block.w);
    document.getElementById('propH').value = Math.round(block.h);
    
    redrawCanvas();
    return;
  }
  
  if (!isDragging) return;
  
  if (draggingBg) {
    bgX = mx - dragOffsetX;
    bgY = my - dragOffsetY;
    redrawCanvas();
    return;
  }
  
  if (draggingBlock && selectedBlockId != null) {
    const b = getBlockById(selectedBlockId);
    b.x = mx - dragOffsetX;
    b.y = my - dragOffsetY;
    document.getElementById('propX').value = Math.round(b.x);
    document.getElementById('propY').value = Math.round(b.y);
    redrawCanvas();
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
function handleEnd() {
  if (isDragging || isResizing) pushStateToUndo();
  isDragging = false;
  isResizing = false;
  draggingBg = false;
  draggingBlock = false;
  resizeHandle = null;
  originalBlock = null;
  canvas.classList.remove('grabbing');
  if (!moveBgMode) canvas.style.cursor = 'grab';
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º—ã—à–∏
canvas.addEventListener('mousedown', handleStart);
canvas.addEventListener('mousemove', handleMove);
canvas.addEventListener('mouseup', handleEnd);
canvas.addEventListener('mouseleave', handleEnd);

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è touch
canvas.addEventListener('touchstart', handleStart, { passive: false });
canvas.addEventListener('touchmove', handleMove, { passive: false });
canvas.addEventListener('touchend', handleEnd);
canvas.addEventListener('touchcancel', handleEnd);

// === –†–ê–ë–û–¢–ê –° –§–û–ù–û–ú ===
document.getElementById('moveBgMode').addEventListener('change', e => {
  moveBgMode = e.target.checked;
  if (moveBgMode) {
    deactivateBlockSelection();
    canvas.style.cursor = 'move';
  } else {
    canvas.style.cursor = 'grab';
  }
});

document.getElementById('bgUploadBtn').addEventListener('click', () => {
  document.getElementById('bgUpload').click();
});

document.getElementById('bgUpload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    pushStateToUndo();
    bgImage = new Image();
    bgImage.src = ev.target.result;
    bgImage.onload = () => {
      bgLoaded = true;
      const aspect = bgImage.width / bgImage.height;
      const canvasAspect = canvasWidth / canvasHeight;
      
      if (aspect > canvasAspect) {
        bgW = canvasWidth;
        bgH = canvasWidth / aspect;
        bgX = 0;
        bgY = (canvasHeight - bgH) / 2;
      } else {
        bgH = canvasHeight;
        bgW = canvasHeight * aspect;
        bgX = (canvasWidth - bgW) / 2;
        bgY = 0;
      }
      
      document.getElementById('removeBgBtn').style.display = 'block';
      redrawCanvas();
    };
  };
  reader.readAsDataURL(file);
});

document.getElementById('removeBgBtn').addEventListener('click', () => {
  pushStateToUndo();
  bgLoaded = false;
  bgImage = new Image();
  document.getElementById('removeBgBtn').style.display = 'none';
  redrawCanvas();
});

// === –ò–ó–ú–ï–ù–ï–ù–ò–ï –†–ê–ó–ú–ï–†–ê –•–û–õ–°–¢–ê ===
document.getElementById('resizeCanvasBtn').addEventListener('click', () => {
  const w = parseInt(document.getElementById('canvasWidth').value);
  const h = parseInt(document.getElementById('canvasHeight').value);
  if (w > 0 && h > 0) {
    pushStateToUndo();
    canvasWidth = w;
    canvasHeight = h;
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    if (bgLoaded) {
      const aspect = bgImage.width / bgImage.height;
      const canvasAspect = canvasWidth / canvasHeight;
      
      if (aspect > canvasAspect) {
        bgW = canvasWidth;
        bgH = canvasWidth / aspect;
        bgX = 0;
        bgY = (canvasHeight - bgH) / 2;
      } else {
        bgH = canvasHeight;
        bgW = canvasHeight * aspect;
        bgX = (canvasWidth - bgW) / 2;
        bgY = 0;
      }
    }
    redrawCanvas();
  }
});

// === –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–ï–ö–¢–ê (–í –§–ê–ô–õ–´) ===
document.getElementById('saveProjectBtn').addEventListener('click', () => {
  const projectData = {
    version: '2.0',
    timestamp: new Date().toISOString(),
    canvas: {
      width: canvasWidth,
      height: canvasHeight
    },
    background: {
      loaded: bgLoaded,
      src: bgLoaded ? bgImage.src : null,
      x: bgX,
      y: bgY,
      width: bgW,
      height: bgH
    },
    blocks: blocks.map(block => {
      const blockData = { ...block };
      if (block.type === 'image') {
        blockData.imageSrc = block.img.src;
        delete blockData.img;
      }
      return blockData;
    }),
    settings: {
      showCenterLines: showCenterLines,
      showSafeZones: showSafeZones,
      safeZoneTop: safeZoneTop,
      safeZoneBottom: safeZoneBottom,
      zoom: scale
    }
  };
  
  const dataStr = JSON.stringify(projectData, null, 2);
  const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
  const time = new Date().toLocaleTimeString('ru-RU').replace(/:/g, '-');
  const filename = `story-project_${date}_${time}.json`;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º iOS
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if (isIOS) {
    // –î–ª—è iOS –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      padding: 20px;
    `;
    
    const header = document.createElement('div');
    header.style.cssText = `
      color: white;
      margin-bottom: 10px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    `;
    header.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞';
    
    const instruction = document.createElement('div');
    instruction.style.cssText = `
      color: white;
      margin-bottom: 20px;
      text-align: center;
      font-size: 14px;
    `;
    instruction.innerHTML = '–í—ã–¥–µ–ª–∏—Ç–µ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ.<br>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "–ó–∞–º–µ—Ç–∫–∏" –∏–ª–∏ "–§–∞–π–ª—ã"';
    
    const textarea = document.createElement('textarea');
    textarea.value = dataStr;
    textarea.readOnly = true;
    textarea.style.cssText = `
      width: 100%;
      height: 50vh;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      background: white;
      color: black;
    `;
    
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = `
      display: flex;
      gap: 10px;
      margin-top: 20px;
    `;
    
    const selectBtn = document.createElement('button');
    selectBtn.textContent = '–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë';
    selectBtn.style.cssText = `
      flex: 1;
      padding: 12px;
      background: #34c759;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    `;
    selectBtn.onclick = () => {
      textarea.select();
      textarea.setSelectionRange(0, 99999);
    };
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
    closeBtn.style.cssText = `
      flex: 1;
      padding: 12px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    `;
    closeBtn.onclick = () => document.body.removeChild(modal);
    
    btnContainer.appendChild(selectBtn);
    btnContainer.appendChild(closeBtn);
    
    modal.appendChild(header);
    modal.appendChild(instruction);
    modal.appendChild(textarea);
    modal.appendChild(btnContainer);
    document.body.appendChild(modal);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç
    setTimeout(() => {
      textarea.select();
      textarea.setSelectionRange(0, 99999);
    }, 100);
  } else {
    // –î–ª—è –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  
  const btn = document.getElementById('saveProjectBtn');
  const originalText = btn.textContent;
  btn.textContent = '‚úî –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
  btn.style.background = 'var(--success)';
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = '';
  }, 2000);
});

document.getElementById('loadProjectBtn').addEventListener('click', () => {
  document.getElementById('loadProjectInput').click();
});

document.getElementById('loadProjectInput').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const projectData = JSON.parse(text);
    
    if (!projectData.version) {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞');
      return;
    }
    
    pushStateToUndo();
    restoreProject(projectData);
    
    const btn = document.getElementById('loadProjectBtn');
    const originalText = btn.textContent;
    btn.textContent = '‚úî –ó–∞–≥—Ä—É–∂–µ–Ω–æ!';
    btn.style.background = 'var(--success)';
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = '';
    }, 2000);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞');
  }
  
  e.target.value = '';
});

// –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤, –∏ –¥–ª—è localStorage)
async function restoreProject(projectData) {
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
  canvasWidth = projectData.canvas.width;
  canvasHeight = projectData.canvas.height;
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  document.getElementById('canvasWidth').value = canvasWidth;
  document.getElementById('canvasHeight').value = canvasHeight;
  
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞
  if (projectData.background.loaded && projectData.background.src) {
    bgImage = new Image();
    bgImage.src = projectData.background.src;
    bgImage.onload = () => {
      bgLoaded = true;
      bgX = projectData.background.x;
      bgY = projectData.background.y;
      bgW = projectData.background.width;
      bgH = projectData.background.height;
      document.getElementById('removeBgBtn').style.display = 'block';
      redrawCanvas();
    };
  } else {
    bgLoaded = false;
    bgX = projectData.background.x;
    bgY = projectData.background.y;
    bgW = projectData.background.width;
    bgH = projectData.background.height;
    document.getElementById('removeBgBtn').style.display = 'none';
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤
  blocks = [];
  topGradientBlock = null;
  bottomGradientBlock = null;
  
  const loadPromises = [];
  
  for (let blockData of projectData.blocks) {
    if (blockData.type === 'image') {
      const img = new Image();
      const loadPromise = new Promise((resolve) => {
        img.onload = () => {
          const block = { ...blockData, img: img };
          delete block.imageSrc;
          blocks.push(block);
          resolve();
        };
      });
      img.src = blockData.imageSrc;
      loadPromises.push(loadPromise);
    } else if (blockData.type === 'gradient') {
      blocks.push(blockData);
      if (blockData.gradientType === 'top') {
        topGradientBlock = blockData;
      } else if (blockData.gradientType === 'bottom') {
        bottomGradientBlock = blockData;
      }
    } else {
      blocks.push(blockData);
    }
  }
  
  await Promise.all(loadPromises);
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤
  if (topGradientBlock) {
    document.getElementById('topGradientControls').style.display = 'block';
    document.getElementById('addTopGradientBtn').style.display = 'none';
    document.getElementById('topGradientHeight').value = topGradientBlock.height;
    document.getElementById('topGradientHeightValue').textContent = topGradientBlock.height + 'px';
    document.getElementById('topGradientOpacity').value = topGradientBlock.opacity * 100;
    document.getElementById('topGradientOpacityValue').textContent = (topGradientBlock.opacity * 100) + '%';
  } else {
    document.getElementById('topGradientControls').style.display = 'none';
    document.getElementById('addTopGradientBtn').style.display = 'block';
  }
  
  if (bottomGradientBlock) {
    document.getElementById('bottomGradientControls').style.display = 'block';
    document.getElementById('addBottomGradientBtn').style.display = 'none';
    document.getElementById('bottomGradientHeight').value = bottomGradientBlock.height;
    document.getElementById('bottomGradientHeightValue').textContent = bottomGradientBlock.height + 'px';
    document.getElementById('bottomGradientOpacity').value = bottomGradientBlock.opacity * 100;
    document.getElementById('bottomGradientOpacityValue').textContent = (bottomGradientBlock.opacity * 100) + '%';
  } else {
    document.getElementById('bottomGradientControls').style.display = 'none';
    document.getElementById('addBottomGradientBtn').style.display = 'block';
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  if (projectData.settings) {
    showCenterLines = projectData.settings.showCenterLines || false;
    showSafeZones = projectData.settings.showSafeZones || false;
    safeZoneTop = projectData.settings.safeZoneTop || 250;
    safeZoneBottom = projectData.settings.safeZoneBottom || 100;
    
    document.getElementById('showCenterLines').checked = showCenterLines;
    document.getElementById('showSafeZones').checked = showSafeZones;
    document.getElementById('safeZoneTop').value = safeZoneTop;
    document.getElementById('safeZoneTopValue').textContent = safeZoneTop + 'px';
    document.getElementById('safeZoneBottom').value = safeZoneBottom;
    document.getElementById('safeZoneBottomValue').textContent = safeZoneBottom + 'px';
    
    if (projectData.settings.zoom) {
      scale = projectData.settings.zoom;
      document.getElementById('zoomSlider').value = scale;
      updateZoom();
    }
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID —Å—á–µ—Ç—á–∏–∫–∞
  if (blocks.length > 0) {
    nextBlockId = Math.max(...blocks.map(b => b.id)) + 1;
  } else {
    nextBlockId = 1;
  }
  
  selectedBlockId = null;
  deactivateBlockSelection();
  refreshBlockList();
  redrawCanvas();
}

// === –≠–ö–°–ü–û–†–¢ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ===
document.getElementById('downloadBtn').addEventListener('click', () => {
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  tempCanvas.width = canvasWidth;
  tempCanvas.height = canvasHeight;
  
  const savedCenterLines = showCenterLines;
  const savedSafeZones = showSafeZones;
  const savedCanvas = canvas;
  const savedCtx = ctx;
  
  canvas = tempCanvas;
  ctx = tempCtx;
  
  showCenterLines = false;
  showSafeZones = false;
  redrawCanvas(true);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, iOS –ª–∏ —ç—Ç–æ
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if (isIOS) {
    // –î–ª—è iOS –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
    tempCanvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      
      // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        overflow-y: auto;
      `;
      
      const instruction = document.createElement('div');
      instruction.style.cssText = `
        color: white;
        margin: 20px;
        text-align: center;
        font-size: 16px;
      `;
      instruction.innerHTML = '–ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ,<br>–∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"';
      
      const img = document.createElement('img');
      img.src = url;
      img.style.cssText = `
        max-width: 90%;
        max-height: 60vh;
        border: 2px solid white;
        border-radius: 8px;
        margin: 20px;
      `;
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
      closeBtn.style.cssText = `
        padding: 12px 24px;
        background: #007aff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        margin-top: auto;
      `;
      closeBtn.onclick = () => {
        document.body.removeChild(modal);
        URL.revokeObjectURL(url);
      };
      
      modal.appendChild(instruction);
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
    });
  } else {
    // –î–ª—è –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    const link = document.createElement('a');
    link.download = 'story.png';
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
  }
  
  canvas = savedCanvas;
  ctx = savedCtx;
  showCenterLines = savedCenterLines;
  showSafeZones = savedSafeZones;
  redrawCanvas();
});

document.getElementById('copyBtn').addEventListener('click', async () => {
  try {
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = canvasWidth;
    tempCanvas.height = canvasHeight;
    
    const savedCenterLines = showCenterLines;
    const savedSafeZones = showSafeZones;
    const savedCanvas = canvas;
    const savedCtx = ctx;
    
    canvas = tempCanvas;
    ctx = tempCtx;
    
    showCenterLines = false;
    showSafeZones = false;
    redrawCanvas(true);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Clipboard API
    if (navigator.clipboard && window.ClipboardItem) {
      tempCanvas.toBlob(async (blob) => {
        try {
          const item = new ClipboardItem({ 'image/png': blob });
          await navigator.clipboard.write([item]);
          showCopySuccess();
        } catch(e) {
          // Fallback –¥–ª—è iOS
          fallbackCopyToClipboard(tempCanvas);
        }
      });
    } else {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏ iOS Safari
      fallbackCopyToClipboard(tempCanvas);
    }
    
    canvas = savedCanvas;
    ctx = savedCtx;
    showCenterLines = savedCenterLines;
    showSafeZones = savedSafeZones;
    redrawCanvas();
  } catch(err) {
    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
    alert('–ù–∞ iOS –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è');
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    showImageForManualCopy();
  }
});
                                                        
function showCopySuccess() {
  const btn = document.getElementById('copyBtn');
  const originalText = btn.textContent;
  btn.textContent = '‚úî –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
  btn.style.background = 'var(--success)';
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = '';
  }, 2000);
}

function fallbackCopyToClipboard(canvas) {
  // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –¥–ª—è iOS
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  const instruction = document.createElement('div');
  instruction.style.cssText = `
    color: white;
    margin-bottom: 20px;
    text-align: center;
    font-size: 16px;
  `;
  instruction.innerHTML = '–ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ,<br>–∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"';
  
  const img = document.createElement('img');
  img.src = canvas.toDataURL('image/png');
  img.style.cssText = `
    max-width: 90%;
    max-height: 70vh;
    border: 2px solid white;
    border-radius: 8px;
  `;
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
  closeBtn.style.cssText = `
    margin-top: 20px;
    padding: 12px 24px;
    background: #007aff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
  `;
  closeBtn.onclick = () => document.body.removeChild(modal);
  
  modal.appendChild(instruction);
  modal.appendChild(img);
  modal.appendChild(closeBtn);
  document.body.appendChild(modal);
}

function showImageForManualCopy() {
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  tempCanvas.width = canvasWidth;
  tempCanvas.height = canvasHeight;
  
  const savedCenterLines = showCenterLines;
  const savedSafeZones = showSafeZones;
  const savedCanvas = canvas;
  const savedCtx = ctx;
  
  canvas = tempCanvas;
  ctx = tempCtx;
  
  showCenterLines = false;
  showSafeZones = false;
  redrawCanvas(true);
  
  fallbackCopyToClipboard(tempCanvas);
  
  canvas = savedCanvas;
  ctx = savedCtx;
  showCenterLines = savedCenterLines;
  showSafeZones = savedSafeZones;
  redrawCanvas();
}

// === –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ===
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    undo();
  }
  if (e.ctrlKey && e.key === 'y') {
    e.preventDefault();
    redo();
  }
  if (e.ctrlKey && e.key === 'd' && selectedBlockId) {
    e.preventDefault();
    duplicateBlock();
  }
  if (e.key === 'Delete' && selectedBlockId) {
    e.preventDefault();
    document.getElementById('deleteBlockBtn').click();
  }
});

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function rgbaToHex(rgba) {
  if (rgba.startsWith('#')) return rgba;
  const parts = rgba.replace(/rgba?|\(|\)|\s/g, '').split(',');
  let r = parseInt(parts[0]), g = parseInt(parts[1]), b = parseInt(parts[2]);
  return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
}

function hexToRgba(hex, alpha = 1) {
  hex = hex.replace('#', '');
  if (hex.length === 3) {
    hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
  }
  const bigint = parseInt(hex, 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r},${g},${b},${alpha})`;
}

// === –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ú–ê–°–®–¢–ê–ë–ê ===
function updateZoom() {
  scale = parseFloat(document.getElementById('zoomSlider').value);
  canvasWrapper.style.transform = `scale(${scale})`;
  document.getElementById('zoomValue').textContent = Math.round(scale * 100) + '%';
}

// === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ú–ê–°–®–¢–ê–ë–ê ===
document.getElementById('zoomSlider').addEventListener('input', updateZoom);
document.getElementById('zoomIn').addEventListener('click', () => {
  scale = Math.min(3, scale + 0.1);
  document.getElementById('zoomSlider').value = scale;
  updateZoom();
});
document.getElementById('zoomOut').addEventListener('click', () => {
  scale = Math.max(0.1, scale - 0.1);
  document.getElementById('zoomSlider').value = scale;
  updateZoom();
});
document.getElementById('zoomReset').addEventListener('click', () => {
  scale = 1;
  document.getElementById('zoomSlider').value = scale;
  updateZoom();
});

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ===
  window.addEventListener('load', () => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    if (loadFromLocalStorage()) {
      console.log('–ü—Ä–æ–µ–∫—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    startAutosave();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
    updateZoom();
    redrawCanvas();
    refreshBlockList();
    deactivateBlockSelection();
    updateUndoRedoButtons();
  });

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  window.addEventListener('beforeunload', () => {
    saveToLocalStorage();
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      saveToLocalStorage();
    }
  });

  // === –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï –ë–û–ö–û–í–û–ô –ü–ê–ù–ï–õ–ò –ù–ê –ú–û–ë–ò–õ–¨–ù–´–• ===
const toggleBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar');
let sidebarCollapsed = false;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
if (window.innerWidth <= 768) {
  toggleBtn.style.display = 'block';
}

toggleBtn.addEventListener('click', () => {
  sidebarCollapsed = !sidebarCollapsed;
  if (sidebarCollapsed) {
    sidebar.style.maxHeight = '60px';
    sidebar.style.overflow = 'hidden';
    toggleBtn.textContent = '‚ñº';
  } else {
    sidebar.style.maxHeight = '60vh';
    sidebar.style.overflow = 'auto';
    toggleBtn.textContent = '‚ò∞';
  }
});

// –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', () => {
  if (window.innerWidth <= 768) {
    toggleBtn.style.display = 'block';
  } else {
    toggleBtn.style.display = 'none';
    sidebar.style.maxHeight = '';
    sidebar.style.overflow = '';
  }
});
  
</script>

</body>

</html>








